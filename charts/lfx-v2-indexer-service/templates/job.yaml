# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT
{{- if .Values.opensearch.indexingJob.enabled }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-opensearch-index-setup
  namespace: {{ .Release.Namespace }}
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      volumes:
        - name: index-config
          configMap:
            name: {{ .Release.Name }}-opensearch-index-config
      containers:
        - name: curl
          image: curlimages/curl:8.11.1
          volumeMounts:
            - name: index-config
              mountPath: /config
              readOnly: true
          command:
            - sh
            - -c
            - |
              set -e
              OPENSEARCH_URL="{{ .Values.opensearch.url | trimSuffix "/" }}"
              INDEX_NAME="{{ .Values.opensearch.index }}"

              # Check if index already exists
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X HEAD "${OPENSEARCH_URL}/${INDEX_NAME}")

              if [ "$HTTP_CODE" = "200" ]; then
                echo "Index '${INDEX_NAME}' already exists, skipping creation"
                exit 0
              elif [ "$HTTP_CODE" = "404" ]; then
                echo "Index '${INDEX_NAME}' does not exist, creating..."
                curl -f -X PUT "${OPENSEARCH_URL}/${INDEX_NAME}" \
                  -H 'Content-Type: application/json' \
                  -d @/config/resources-index.json
                echo "Index '${INDEX_NAME}' created successfully"
              else
                echo "Unexpected response checking index: HTTP ${HTTP_CODE}"
                exit 1
              fi
{{- end }}
